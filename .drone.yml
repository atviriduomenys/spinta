---
kind: pipeline
type: docker
name: deploy-docker-compose

platform:
  os: linux
  arch: amd64

steps:
  - name: deploy-with-docker-compose
    image: docker:cli
    volumes:
    - name: docker_sock
      path: /var/run/docker.sock
    privileged: true
    commands:
      - echo "Deploying application for branch ${DRONE_BRANCH}..."
      - apk add gettext
      - export BRANCH=${DRONE_BRANCH/\//-}
      - export INTERNAL_HOST=spinta-$${BRANCH}-app
      - if [ "$SPINTA_INTERNAL" == "true" ]; then envsubst < docker-compose.template.internal.yml > docker-compose.${DRONE_BRANCH//\//-}.yml; else envsubst < docker-compose.template.yml > docker-compose.${DRONE_BRANCH//\//-}.yml; fi
      - if [ "$SPINTA_INTERNAL" == "true" ]; then sed -i "s/PLACEHOLDER/$${INTERNAL_HOST}/g" nginx/nginx-internal.conf; fi
      - docker compose -p spinta-${DRONE_BRANCH/\//-} -f docker-compose.${DRONE_BRANCH/\//-}.yml build --no-cache
      - docker compose -p spinta-${DRONE_BRANCH/\//-} -f docker-compose.${DRONE_BRANCH/\//-}.yml down || true
      - docker compose -p spinta-${DRONE_BRANCH/\//-} -f docker-compose.${DRONE_BRANCH/\//-}.yml up -d --remove-orphans
      - sleep 30 && docker logs spinta-${DRONE_BRANCH/\//-}-spinta-${DRONE_BRANCH/\//-}-1
      - docker image prune -a -f
volumes:
  - name: docker_sock
    host:
      path: /var/run/docker.sock
node:
  label: runner
trigger:
  ref:
    exclude:
      - refs/tags/**
      - refs/heads/master

---
kind: pipeline
type: docker
name: build-image

platform:
  os: linux
  arch: amd64

steps:
  - name: build-image
    image: docker:cli
    volumes:
      - name: docker_sock
        path: /var/run/docker.sock
      - name: docker_auth
        path: /root/.docker/config.json
    privileged: true
    commands:
      - docker image prune -a -f
      - docker login
      - export REGISTRY=vssadevops/spinta
      - export SHORT_SHA=${DRONE_COMMIT_SHA:0:8}
      - docker build -f production.Dockerfile -t $${REGISTRY}:latest -t $${REGISTRY}:$${SHORT_SHA} -t $${REGISTRY}:$${DRONE_TAG##refs/tags/:-latest} .
      - docker push $${REGISTRY}:$${SHORT_SHA}
      - docker push $${REGISTRY}:latest
      - docker push $${REGISTRY}:$${DRONE_TAG##refs/tags/:-latest}
      - docker image prune -a -f
volumes:
  - name: docker_sock
    host:
      path: /var/run/docker.sock
  - name: docker_auth
    host:
      path: /root/.docker/config.json
node:
  label: runner-saugykla-dev1
trigger:
  ref:
    include:
      - refs/tags/**

---
kind: pipeline
type: docker
name: deploy-docker-compose-dev

platform:
  os: linux
  arch: amd64

steps:
  - name: deploy-with-docker-compose
    image: docker:cli
    volumes:
    - name: docker_sock
      path: /var/run/docker.sock
    privileged: true
    commands:
      - apk add gettext
      - export BRANCH=${DRONE_BRANCH/\//-}
      - envsubst < docker-compose.dev.yml > docker-compose.yml
      - docker compose -f docker-compose.yml build --no-cache
      - docker compose -f docker-compose.yml down || true
      - docker compose -f docker-compose.yml up -d
      - sleep 30 && docker logs src-spinta-1
      - docker image prune -a -f
volumes:
  - name: docker_sock
    host:
      path: /var/run/docker.sock
node:
  label: runner-saugykla-dev1
trigger:
  ref:
    include:
      - refs/heads/master
    exclude:
      - refs/tags/**
